#######################################################################################################################
##################  This code models the trajectories based on parameters generated by Monolix ######################## 
#######################################################################################################################

```{r}
library(deSolve)
library(ggplot2)
library(dplyr)
library(purrr)
library(MASS)
```


############ For antibodies, we use an exponential model to simulate the trajectories ###############
```{r}
pop <- read.csv("populationParameters.txt",  row.names = 1) # read igg paramters or nAb parameters
```


```{r}
ode_ab_pop <- function(pars, immu) {
  
  k1 <- as.numeric(pars[1]) # Growth rate in phase 1
  k2 <- as.numeric(pars[2]) # Decay rate in phase 2
  k3 <- as.numeric(pars[3]) # Growth rate after inf/booster
  k4 <- as.numeric(pars[4]) # Decay rate after inf/booster
  A0 <- as.numeric(pars[5]) # Initial condition
  tau <- as.numeric(pars[6])  # timing of peak
  
  times <- c(seq(Tmin, Tmax, step_size))
  
  infection <- data.frame(times = times, un_inf = rep(0, length(times)), inf_1 = rep(0, length(times)),boost_1 = rep(0, length(times)), 
                          inf_boost = rep(0, length(times)), inf_boost_inf= rep(0, length(times)),  inf_inf = rep(0, length(times)))
  
  infection <- infection %>% mutate(un_inf =
                                      case_when(times <= tau ~ k1, 
                                                times > tau ~ -k2),
                                                
                                    inf_1 = 
                                      case_when(times <= tau ~ k1, 
                                                times > tau & times <= 152 ~ -k2,
                                                times > 152 & times <= 152+tau ~ k3,
                                                times > 152+tau ~ -k4),
                                    boost_1 = 
                                      case_when(times <= tau ~ k1, 
                                                times > tau & times <= 303 ~ -k2,
                                                times > 303 & times <= 303+tau ~ k3,
                                                times > 303+tau ~ -k4),
                                    inf_boost = 
                                      case_when(times <= tau ~ k1, 
                                                times > tau & times <= 152 ~ -k2,
                                                times > 152 & times <= 152+tau ~ k3,
                                                times > 152+tau & times <= 303 ~ -k4,
                                                times > 303 & times <= 303+tau ~ k3,
                                                times > 303+tau ~ -k4)
                                  
                                                )
  
  k_t <- approxfun(infection$times, infection[,immu+1], rule = 2) # immu = 1, uninf; immu = 2, infected, immu = 3, boosted; immu = 4, infected+boosted
  
  derivs<-function(times,y,pars,k_t){
    with(as.list(c(pars,y)),{
      k <- k_t(times)   # <---- here
      dA <- k*A
      return(list(c(dA)))
    })
  }
  y<-c(A=A0)
  
  
  out<-ode(y=y,parms=pars,times=times,func=derivs, k_t=k_t)
  as.data.frame(out)
}
```
###############################################################################
############ Sample function to generate a virtual cohort #####################
###############################################################################
```{r}
#generate sample parameters from population parameters 
sample_ab <- function(pop, num){
  
  inds_mean <- which(rownames(pop) %in% c("k1_pop","k2_pop","k3_pop","k4_pop","A0_pop", 'tau_pop')) #row number of parameters
  inds_sd <- which(rownames(pop) %in% c("omega_k1","omega_k2","omega_k3","omega_k4","omega_A0", "omega_tau"))

  pars <- matrix(0, num+1, length(inds_mean))
  
  for (i in 1:length(inds_mean)) {
    mean_par <- pop$value[inds_mean[i]]
    sd_par <- pop$value[inds_sd[i]]
    #sd_par <- pop$se_sa[inds_mean[i]] ####standard error of population parameter
    
    if (i==1) {
      log_k1 = log(mean_par)
      pars[1:num, i] <- exp(rnorm(num, mean = log_k1, sd=sd_par))
      pars[num+1, i] <- exp(log_k1)
    } 
    
    else if (i==2 ) {
      log_k2 = log(mean_par)
      pars[1:num, i] <- exp(rnorm(num, mean = log_k2, sd=sd_par))
      pars[num+1, i] <- exp(log_k2)
    } 
    
    else if (i==3 ) {
      log_k3 = log(mean_par)
      pars[1:num, i] <- exp(rnorm(num, mean = log_k3, sd=sd_par))
      pars[num+1, i] <- exp(log_k3)
    } 
    
    else if (i==4 ) {
      log_k4 = log(mean_par)
      pars[1:num, i] <- exp(rnorm(num, mean = log_k4, sd=sd_par))
      pars[num+1, i] <- exp(log_k4)
    } 
    
    else if (i==5) {
      log_A0 = log(mean_par)
      pars[1:num, i] <- exp(rnorm(num, mean=log_A0, sd=sd_par))
      pars[num+1, i] <- exp(log_A0)
    }
    else if (i==6 ) {
      log_tau = log(mean_par)
      pars[1:num, i] <- exp(rnorm(num, mean=log_tau, sd=sd_par))
      pars[num+1, i] <- exp(log_tau)
    } 
  }
  return(pars)
}
```
```{r}
run_ODE_control <- function(pars, immu){
  total_AL <- matrix(NA,nrow=length(seq(Tmin,Tmax,step_size)),ncol=n)
  for(i in 1:n){
    out <- ode_ab_pop(pars[i, ], immu = immu[i])
  total_AL[,i] <- out$A
  }
  return(total_AL)
}
```
############## For population fitting, create the sample conditions
```{r}
  immu_detail <- data.frame(immu_group = c( "uninfected", 
                                  "infected", 
                                  "boosted", 
                                  "infected_boosted"
                                  ),
                         immu = c(1,2,3,4)
                 )
immu_detail
```
################################################
############## Start simulation ################
################################################
```{r}

n = 1000 #1000 simulations

Tmin <- 0
Tmax <- 450  #set 1000 for simulating trajectories used in protection estimation 
step_size <- 1
times<-c(seq(Tmin,Tmax,step_size))

Fit <- list()
pb <- txtProgressBar(min = 0, max = 4, style = 3)
for (g in 1:4){
  immu_i <- immu_detail$immu[g]
  rep_immu <- rep(immu_i, n+1)
  
  par <- c(k1 = pop["k1_pop", "value"],
           k2 = pop["k2_pop", "value"],
           k3 = pop["k3_pop", "value"],
           k4 = pop["k4_pop", "value"],
           A0=pop["A0_pop", "value"],
           tau = pop["tau_pop", "value"])
  
  best_fit <- ode_ab_pop(par, immu = immu_i)
  
  pars <- sample_ab(pop, n)
  total_VL <- run_ODE_control(pars, immu = rep_immu)
  
  Min90  <- apply(total_VL,1,function(x){quantile(x,0.05,na.rm=T)})
  Max90  <- apply(total_VL,1,function(x){quantile(x,0.95,na.rm=T)})
  Min50  <- apply(total_VL,1,function(x){quantile(x,0.25,na.rm=T)})
  Max50  <- apply(total_VL,1,function(x){quantile(x,0.75,na.rm=T)})
  Mean50  <- apply(total_VL,1,function(x){quantile(x,0.5,na.rm=T)})
  Min30 <- apply(total_VL,1,function(x){quantile(x,0.3,na.rm=T)}) ### highest boundary of 30% worst responders
  Max30 <- apply(total_VL,1,function(x){quantile(x,0.7,na.rm=T)}) ### lowest boundary 0f 30% best responders
 
  
  Fit[[g]] <- cbind(best_fit,
                    Min90,
                    Max90,
                    Min50,
                    Max50,
                    Mean50,
                    Min30,
                    Max30, 
                    rep(immu_i,length(times)))
  Fit[[g]] <- data.frame(Fit[[g]])
  colnames(Fit[[g]]) <- c("time","best_fit",
                          "Min90",
                          "Max90",
                          "Min50",
                          "Max50",
                          "Mean50",
                          "Min30","Max30","Immu_group")
  Fit[[g]]$Max90[Fit[[g]]$Max90 > 4500] <- 4500
  Fit[[g]]$Max50[Fit[[g]]$Max50 > 4500] <- 4500
  setTxtProgressBar(pb, g)
}
close(pb)
combine_pop <- map_df(Fit, ~as.data.frame(.x))
```
```{r}
combine_pop1<- merge(immu_detail,combine_pop, by.x = "immu", by.y = "Immu_group")
combine_pop1 <- combine_pop1 %>% mutate(
  log_upr=log10(Max90),
  log_lwr=log10(Min90),
  log_upr1=log10(Max50),
  log_lwr1=log10(Min50),
  log_igg=log10(best_fit)
)
combine_pop1
```
################################
############ Fig-3-AB ###########
################################
```{r}
# Create the plot
plot_pop_log <- ggplot(combine_pop1, aes(x = time, y = log_igg, group = immu_group)) +
  
  geom_ribbon(aes(ymin = log_upr1, ymax = log_lwr1, fill = immu_group), alpha = 0.3) +
  geom_ribbon(aes(ymin = log_upr, ymax = log_lwr, fill = immu_group), alpha = 0.15) +
  
  geom_line(aes(color = immu_group),linewidth = 1.5) +
  
  geom_vline(data =immu_detail_1,  aes(xintercept = inf, group = immu_group),color = "red",linetype = "dotted", size = 1, alpha = 0.5) +
  geom_vline(data =immu_detail_1,  aes(xintercept = boost, group = immu_group),color = "blue",linetype = "dotted", size = 1, alpha = 0.5) +
   facet_wrap(~ immu_group) +
  labs(
    #title = "Visualization of Antibody Response (Anti-S-IgG)",
    x = "Time (days)",
    y = "log10 Anti-S-IgG (U/ml)",
    color = "Group",
    fill = "Group"
  ) +
  theme(axis.text = element_text(colour = "black"),
        axis.ticks = element_line(colour = "black"),
        axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        legend.position='none',
        #axis.title.y = element_text(size=11,family="sans"),
        axis.title.x = element_text(size=12,family="sans"),
        #strip.text = element_text(size = 12,family="sans"),
  theme_minimal() 
  ) 
plot_pop_log
```

##################################################################################
################ read individual immunity detail and raw data ####################
##################################################################################
```{r}
Original <- read.csv("")
Original
immu_detail_individuals <- read.csv("immu_detail_individuals_reinf.csv")
immu_detail_individuals
Original_immu <- merge(Original,immu_detail_individuals[,c(1,8,9)], by = "ID") %>%
  rename(Code = ID)
Original_immu
```

########## individual trajectory function: consider reinfection ############
```{r}
ode_ab_ind <- function(pars, immunity) { #Here immu is a list
  
  k1 <- as.numeric(pars[1]) # Growth rate in phase 1
  k2 <- as.numeric(pars[2]) # Decay rate in phase 2
  k3 <- as.numeric(pars[3]) # Growth rate after inf/booster
  k4 <- as.numeric(pars[4]) # Decay rate after inf/booster
  A0 <- as.numeric(pars[5]) # Initial condition
  tau <- as.numeric(pars[6])  # timing of peak
  
  t_inf <- as.numeric(immunity[3])
  t_boost <- as.numeric(immunity[5])
  t_inf_2 <- as.numeric(immunity[7])
  immu <- as.numeric(immunity[8])
  adjusted <- min(t_inf+tau,t_boost) #adjust the time scale for some cases whose t_inf + tau > t_boost
  
  
  times <- c(seq(Tmin, Tmax, step_size))
  
  infection <- data.frame(times = times, VV = rep(0, length(times)), VVI = rep(0, length(times)),VVV = rep(0, length(times)), 
                          VVIV = rep(0, length(times)),VVIVI = rep(0, length(times)),VVII = rep(0, length(times)))
  
 infection <- infection %>% mutate(VV =
                                      case_when(times <= tau ~ k1, 
                                                times > tau ~ -k2),
                                                
                                    VVI = 
                                      case_when(times <= tau ~ k1, 
                                                times > tau & times <= t_inf ~ -k2,
                                                times > t_inf & times <= t_inf+tau ~ k3,
                                                times > t_inf+tau ~ -k4),
                                    VVV = 
                                      case_when(times <= tau ~ k1, 
                                                times > tau & times <= t_boost ~ -k2,
                                                times > t_boost & times <= t_boost+tau ~ k3,
                                                times > t_boost+tau ~ -k4),
                                    VVIV = 
                                      case_when(times <= tau ~ k1, 
                                                times > tau & times <= t_inf ~ -k2,
                                                times > t_inf & times <= adjusted ~ k3,
                                                times > adjusted & times <= t_boost ~ -k4,
                                                times > t_boost & times <= t_boost+tau ~ k3,
                                                times > t_boost+tau ~ -k4),
                                   VVIVI = 
                                      case_when(times <= tau ~ k1, 
                                                times > tau & times <= t_inf ~ -k2,
                                                times > t_inf & times <= adjusted ~ k3,
                                                times > adjusted & times <= t_boost ~ -k4,
                                                times > t_boost & times <= t_boost+tau ~ k3,
                                                times > t_boost+tau & times <= t_inf_2 ~ -k4,
                                                times > t_inf_2 & times <= t_inf_2+tau ~ k3,
                                                times > t_inf_2+tau  ~ -k4),
                                    VVII = 
                                      case_when(times <= tau ~ k1, 
                                                times > tau & times <= t_inf ~ -k2,
                                                times > t_inf & times <= t_inf+tau ~ k3,
                                                times > t_inf+tau & times <= t_inf_2 ~ -k4,
                                                times > t_inf_2 & times <= t_inf_2+tau ~ k3,
                                                times > t_inf_2+tau  ~ -k4
                                                ))
  
  k_t <- approxfun(infection$times, infection[,immu+1], rule = 2) # immu = 1, uninf; immu = 2, infected..
  
  derivs<-function(times,y,pars,k_t){
    with(as.list(c(pars,y)),{
      k <- k_t(times)   # <---- here
      dA <- k*A
      return(list(c(dA)))
    })
  }
  y<-c(A=A0)
  
  
  out<-ode(y=y,parms=pars,times=times,func=derivs, k_t=k_t)
  as.data.frame(out)
}
```
######### read monolix results
```{r}
Est <- read.csv("estimatedIndividualParameters.txt", sep = ",", comment.char = "", header = T)
Simulated <- read.csv("simulatedIndividualParameters.txt", sep = ",", comment.char = "", header = T)
Est
Simulated
```
######## simulation function
```{r}
Tmin <- 0
Tmax <- 450 
step_size <- 1
times<-c(seq(Tmin,Tmax,step_size))

ind_fit_plt<-function(Est,Simulated,immunity){
  
  Fit <- list()
  for(i in 1:nrow(Est)){
    pars <- c(k1=Est$k1_mode[i],
              k2=Est$k2_mode[i],
              k3=Est$k3_mode[i],
              k4=Est$k4_mode[i],
              A0=Est$A0_mode[i],
              tau = Est$tau_mode[i])
    
    target_id <- Est$id[i]
    #immu_i <- immunity %>% filter(ID == target_id)
    immu_i = immunity[i,]
    fitted <- ode_ab_ind(pars,immu_i)
    d1 <- data.frame(Days=(times),y=(fitted$A))
    Code <- Est$id[i]
    
    max_fit <- max(d1$y)
    
    S <- 50 ###100 repeats
    P <- matrix(NA,nrow=length(times),ncol=S)
    
    
    for(j in 1:S){
      pars <- c(k1=Simulated$k1[j+S*(i-1)],
                k2=Simulated$k2[j+S*(i-1)],
                k3=Simulated$k3[j+S*(i-1)],
                k4=Simulated$k4[j+S*(i-1)],
                A0=Simulated$A0[j+S*(i-1)],
                tau=Simulated$tau[j+S*(i-1)])
      
      out  <- ode_ab_ind(pars,immu_i)
      P[,j] <- out$A
    }
    
    Min  <- apply(P,1,function(x){quantile(x,0.05)})
    Max  <- apply(P,1,function(x){quantile(x,0.95)})
    
    fit <- cbind(d1,Min,Max,Code)
    fit$Max[fit$Max> max(max_fit,4500)] <- max(max_fit,4500) #set contraints
    #fit$Min[fit$Min> 100] <- 100
    
    Fit[[i]] <- data.frame(fit)
  }
  
  ind_fit_unlist <- map_df(Fit, ~as.data.frame(.x))
  ind_fit <- merge(ind_fit_unlist, immunity, by.x="Code", by.y = "ID", all.x=TRUE) 
  ind_fit$Code <- as.factor(ind_fit$Code)
  ind_fit <- ind_fit[order(ind_fit$Code, ind_fit$Days), ]
  return(ind_fit)
}
```
```{r}
individual_fit <- ind_fit_plt(Est, Simulated, immunity = immu_detail_individuals) # run function
```
```{r}
individual_fit <- individual_fit[,-14] %>% mutate( immune_group = case_when(immu == 1 ~ "uninfected", 
                                                immu == 3 ~ "boosted", 
                                               immu == 2| immu == 6 ~ "infected", 
                                               immu == 4| immu == 5 ~ "infected_boosted"))
individual_fit

Original_immu<- Original_immu %>% mutate( immune_group = case_when(immu == 1 ~ "uninfected", 
                                                immu == 3 ~ "boosted", 
                                               immu == 2| immu == 6 ~ "infected", 
                                               immu == 4| immu == 5 ~ "infected_boosted"))
Original_immu
```


######### individual immunity-confering event ##########
```{r}
ind_inf <- immu_detail_individuals %>%
  rename(Code = ID) %>%
  filter(inf != 0) %>%
  dplyr::select(Code,t_inf) 

ind_inf

ind_boost <- immu_detail_individuals %>%
  rename(Code = ID) %>%
  filter(boost != 0) %>%
  dplyr::select(Code,t_boost)
 
ind_boost

ind_reinf <- immu_detail_individuals %>%
  rename(Code = ID) %>%
  filter(reinf != 0) %>%
  dplyr::select(Code,t_inf_2)
 
ind_reinf
```
######################################
######### S Figure 2,3 ###############
######################################
```{r}
plot_indfit <- ggplot(individual_fit, aes(x = Days)) +
 
  geom_ribbon(aes(ymin = Min, ymax = Max, fill = immune_group), alpha = 0.3) +

  geom_line(aes(y = y, color = immune_group), size = 1, alpha = 0.8) +
  
  
  geom_vline(data =ind_inf,  aes(xintercept = t_inf),color = "red",linetype = "dotted", size = 1, alpha = 0.5) +
  geom_vline(data =ind_boost,  aes(xintercept = t_boost),color = "blue",linetype = "dotted", size = 1, alpha = 0.5) +
  geom_vline(data =ind_reinf,  aes(xintercept = t_inf_2),color = "red",linetype = "dotted", size = 1, alpha = 0.5) +
  #add inf time, boost time
  geom_point(data = Original_immu, aes(x = Day, y = Anti.S.IgG, color = immune_group), 
             shape = 16, size = 2, alpha = 2) +

   facet_wrap(~ Code,scales = "free_y" )+
 theme(axis.text = element_text(colour = "black"),
        axis.ticks = element_line(colour = "black"),
        axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        legend.position='bottom',
        axis.title.y = element_text(size=11,family="sans"),
        axis.title.x = element_text(size=11,family="sans"),
  theme_minimal() 
  )   +
  
  labs(
    #title = "Individual Fit with Shaded Uncertainty",
    x = "Time (days)",
    y = "Anti-S-IgG (U/ml)",
    fill = "Immune Group",
    color = "Immune Group"
  ) 

plot_indfit
```

