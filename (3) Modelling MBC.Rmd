#######################################################################################################################
##################  This code models the trajectories based on parameters generated by Monolix ######################## 
#######################################################################################################################

```{r}
library(deSolve)
library(ggplot2)
library(dplyr)
library(purrr)
library(MASS)
```

############ For MBC, we use an inactivation model to simulate the trajectories ###############
```{r}
pop <- read.csv("populationParameters.txt",  row.names = 1) # read MBC parameters
```


########## MBC function, assume infection and booster has no impact on it #############
```{r}
ode_MBC_pop <- function(pars) {
  
  alpha <- as.numeric(pars[1]) # Growth term
  gamma <- as.numeric(pars[2]) #time-dependent deteriorate
  beta <- as.numeric(pars[3]) # decay term
  B0 <- as.numeric(pars[4]) # Initial b cell level
 
  
  times <- c(seq(Tmin, Tmax, step_size))
  
 B_cell_model_simple <- function(t, y, pars) {
  with(as.list(c(pars, y)), {
    dB <- alpha * exp(-gamma*t) - beta * B 
    
    return(list(c(dB)))
  })
}
  y<-c(B=B0)
  
  
  out<-ode(y=y,parms=pars,times=times,func=B_cell_model_simple)
  as.data.frame(out)
}
```

######### Sample function to generate virtual cohort ################
```{r}
sample_MBC <- function(pop, num){
  
  inds_mean <- which(rownames(pop) %in% c("alpha_pop","gamma_pop","beta_pop","B0_pop")) #row number of parameters
  inds_sd <- which(rownames(pop) %in% c("omega_alpha","omega_gamma","omega_beta","omega_B0"))

  pars <- matrix(0, num+1, length(inds_mean))
  
  for (i in 1:length(inds_mean)) {
    mean_par <- pop$value[inds_mean[i]]
    sd_par <- pop$value[inds_sd[i]]
    #sd_par <- pop$se_sa[inds_mean[i]] ####standard error of population parameter
    
    if (i==1) {
      log_alpha = log(mean_par)
      pars[1:num, i] <- exp(rnorm(num, mean = log_alpha, sd=sd_par))
      pars[num+1, i] <- exp(log_alpha)
    } 
    
    else if (i==2 ) {
      log_gamma = log(mean_par)
      pars[1:num, i] <- exp(rnorm(num, mean = log_gamma, sd=sd_par))
      pars[num+1, i] <- exp(log_gamma)
    } 
    
    else if (i==3 ) {
      log_beta = log(mean_par)
      pars[1:num, i] <- exp(rnorm(num, mean = log_beta, sd=sd_par))
      pars[num+1, i] <- exp(log_beta)
    } 
    
    else if (i==4 ) {
      log_B0 = log(mean_par)
      pars[1:num, i] <- exp(rnorm(num, mean = log_B0, sd=sd_par))
      pars[num+1, i] <- exp(log_B0)
    } 
    
  }
  
  return(pars)
}
```

```{r}
run_ODE_control_MBC <- function(pars){
  total_MBC <- matrix(NA,nrow=length(seq(Tmin,Tmax,step_size)),ncol=n)
  for(i in 1:n){
    out <- ode_MBC_pop(pars[i,])
  total_MBC[,i] <- out$B
  }
  return(total_MBC)
}
```

########### Population level fitting ############
```{r}
n = 1000 #1000 simulations

Tmin <- 0
Tmax <- 1000 
step_size <- 1
times<-c(seq(Tmin,Tmax,step_size))

Fit <- list()

for (g in 1:1){

  par <- c(alpha = pop["alpha_pop", "value"],
           gamma = pop["gamma_pop", "value"],
           beta = pop["beta_pop", "value"],
           B0 = pop["B0_pop", "value"])
  
  best_fit <- ode_MBC_pop(par)
  
  pars <- sample_MBC(pop, n)
  total_MBC <- run_ODE_control_MBC(pars)
  
  Min95  <- apply(total_MBC,1,function(x){quantile(x,0.025,na.rm=T)})
  Max95  <- apply(total_MBC,1,function(x){quantile(x,0.975,na.rm=T)})
  Min50  <- apply(total_MBC,1,function(x){quantile(x,0.25,na.rm=T)})
  Max50  <- apply(total_MBC,1,function(x){quantile(x,0.75,na.rm=T)})
  Mean50  <- apply(total_MBC,1,function(x){quantile(x,0.5,na.rm=T)})
  Min30 <-apply(total_MBC,1,function(x){quantile(x,0.3,na.rm=T)})
  Max30 <-apply(total_MBC,1,function(x){quantile(x,0.7,na.rm=T)})

  Fit[[g]] <- cbind(best_fit,Min95,Max95,Min50,Max50,Mean50,Min30, Max30)
  Fit[[g]] <- data.frame(Fit[[g]])
  colnames(Fit[[g]]) <- c("time","best_fit","Min95","Max95","Min50","Max50","Mean50", "Min30", "Max30")
 
}

combine_pop <- map_df(Fit, ~as.data.frame(.x))
```
##################################################
#################### Figure 3C ###################
##################################################
```{r}
# Create the plot
plot_pop_log<- ggplot(combine_pop, aes(x = time, y = log10(best_fit))) +
  
  geom_ribbon(aes(ymin = log10(Min95), ymax = log10(Max95)), fill = "grey", alpha = 0.15) +
  geom_ribbon(aes(ymin = log10(Min50), ymax = log10(Max50)), fill = "grey", alpha = 0.3) +
  
  geom_line(color = "black",linewidth = 1.5) +
  
  geom_vline(  aes(xintercept = 156),color = "red",linetype = "dotted", linewidth = 1, alpha = 0.3) +
  geom_vline(  aes(xintercept = 307),color = "blue",linetype = "dotted", linewidth = 1, alpha = 0.3) +
  
  labs(
    #title = "Visualization of Population SPIKE-MBC Level",
    x = "Time (days)",
    y = "log 10 Percentage of S+ MBCs out of total B cells (%)",
  ) +
  theme(axis.text = element_text(colour = "black"),
        axis.ticks = element_line(colour = "black"),
        axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        legend.position='none',
        axis.title.y = element_text(size=11,family="sans"),
        axis.title.x = element_text(size=11,family="sans"),
  theme_minimal() 
  )+
  theme(legend.position = "top")
plot_pop_log
```

#################################################################################
########################## Individual Fitting ###################################
#################################################################################

############ read raw data 
```{r}
Original <- read.csv("")
Original <- Original %>%
  rename(Code = ID)
Original
```
######### read monolix results
```{r}
Est <- read.csv("estimatedIndividualParameters.txt", sep = ",", comment.char = "", header = T)
Simulated <- read.csv("simulatedIndividualParameters.txt", sep = ",", comment.char = "", header = T)
Est
Simulated
```


####### ODE for individual MBC 
```{r}
Tmin <- 0
Tmax <- 500 
step_size <- 1
times<-c(seq(Tmin,Tmax,step_size))


ind_fit_plt<-function(Est,Simulated){
  
  Fit <- list()
  for(i in 1:nrow(Est)){ #For each individual: each id, extract parameters and fit them
    pars <- c(alpha=Est$alpha_mode[i],
              gamma=Est$gamma_mode[i],
              beta=Est$beta_mode[i],
              B0=Est$B0_mode[i])
  
 
    fitted <- ode_MBC_pop(pars)
    d1 <- data.frame(Days=(times),y=(fitted$B))
    Code <- Est$id[i]
    

    
     S <- max(Simulated$rep) ###100 repeats
    P <- matrix(NA,nrow=length(times),ncol=S)
    
    
    for(j in 1:S){   
      pars <- c(alpha=Simulated$alpha[j+S*(i-1)],
                gamma=Simulated$gamma[j+S*(i-1)],
                beta=Simulated$beta[j+S*(i-1)],
                B0=Simulated$B0[j+S*(i-1)]
               )
      
      out  <- ode_MBC_pop(pars)
      P[,j] <- out$B
    }
    
    Min  <- apply(P,1,function(x){quantile(x,0.0005)})
    Max  <- apply(P,1,function(x){quantile(x,0.9995)})
    
    fit <- cbind(d1,Min,Max,Code)
    
    Fit[[i]] <- data.frame(fit)
  }
  
  ind_fit_unlist <- map_df(Fit, ~as.data.frame(.x))
 
  ind_fit <- ind_fit_unlist
  ind_fit$Code <- as.factor(ind_fit$Code)
  ind_fit <- ind_fit[order(ind_fit$Code, ind_fit$Days), ]
  return(ind_fit)
}
```
```{r}
individual_fit_MBC <- ind_fit_plt(Est, Simulated)
```
```{r}
ind_inf <- Original %>%
  filter(inf != 0) %>%
  dplyr::select(Code,t_inf) %>%
  group_by(Code) %>%
  slice_head(n=1)
ind_inf

ind_boost <- Original %>%
  filter(boost != 0) %>%
  dplyr::select(Code,t_boost) %>%
  group_by(Code) %>%
  slice_head(n=1)
ind_boost

ind_reinf <- Original %>%
  filter(reinf != 0) %>%
  dplyr::select(Code,t_inf_2) %>%
  group_by(Code) %>%
  slice_head(n=1)
ind_reinf

```

############## S-Fig-4 ################
```{r}
plot_indfit <- ggplot(individual_fit_MBC, aes(x = Days)) +
 
  geom_ribbon(aes(ymin = log10(Min), ymax = log10(Max)), fill = "darkgrey", alpha = 0.4) +

  geom_line(aes(y = log10(y)), color = "black", linewidth = 1, alpha = 0.8) +
  
  
  geom_vline(data =ind_inf,  aes(xintercept = t_inf),color = "red",linetype = "dotted", linewidth = 1, alpha = 0.5) +
  geom_vline(data =ind_boost,  aes(xintercept = t_boost),color = "blue",linetype = "dotted", linewidth = 1, alpha = 0.5) +
  geom_vline(data =ind_reinf,  aes(xintercept = t_inf_2),color = "red",linetype = "dotted", linewidth = 1, alpha = 0.5) +
  #add inf time, boost time
  geom_point(data = Original, aes(x = Day, y = log10(SPIKE_MBC)), color = "black",
             shape = 16, size = 2, alpha = 2) +
 
  facet_wrap(~ Code )+
 theme(axis.text = element_text(colour = "black"),
        axis.ticks = element_line(colour = "black"),
        axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        legend.position='bottom',
        axis.title.y = element_text(size=11,family="sans"),
        axis.title.x = element_text(size=11,family="sans"),
  theme_minimal() 
  )   +
  
  labs(
    #title = "Individual Fit of SPIKE-MBC",
    x = "Time (days)",
    y = "log10 percentage of S+ MBCs out of total B cells (%)",
    fill = "Immu Group",
    color = "Immu Group"
  ) 

plot_indfit
```

