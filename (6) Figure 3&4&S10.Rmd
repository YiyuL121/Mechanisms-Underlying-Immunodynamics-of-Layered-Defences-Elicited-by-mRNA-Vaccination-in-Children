#######################################################################################################################
################# This code generates figure3 and figure4, based on results of survival analysis ######################
#######################################################################################################################


```{r}
library(ggplot2)
library(dplyr)
```

###########################################
############ Figure 3 A  ##################
###########################################

```{r}

## Hazard ratio ##

data <- data.frame(
  Biomarker = rep(c("T cell response\n (IFNg in pg/ml)","Spike-MBC (%)","Neutralising\u2003 \n antibody titres (IC50)" ,"Anti-S-IgG (U/ml)" ), each = 6),
  Study_Period = rep(rep(c("30D-3M", "3M-6M", "6M-12M"), each = 2), times = 4),
  Condition = rep(c("including hybrid immune children", "vaccine-only children"), times = 12),
  Hazard_Ratio = c(
    
    # IFN-γ (pg/ml)
    1.12, 1.12, 0.11, 0.17, 0.19, 0.35,
    # Spike-MBC (%)
    4.11, 4.11, 0.02, 0.04, 9.66, 8.07,
    # nAb
    0.06, 0.06, 0.18, 1.38, 0.26, 2.17,
    # Anti-S-IgG (U/ml)
    0.13, 0.13, 0.16, 0.57, 0.42, 5
    
  ),
  CI_lower = c(
      # IFN-γ (pg/ml)
    0.43, 0.43, 0.04, 0.05, 0.09, 0.13,
    
    # Spike-MBC (%)
    0.87, 0.87, 0.001, 0.004, 0.94, 0.4,
    # nAb
    0.004, 0.004, 0.06, 0.25, 0.09, 0.40,
    # Anti-S-IgG (U/ml)
    0.02, 0.02, 0.06, 0.12, 0.19, 0.57
  ),
  CI_upper = c(
      # IFN-γ (pg/ml)
    2.9, 2.9, 0.3, 0.55, 0.39, 0.95,
    # Spike-MBC (%)
    19, 19, 0.3, 0.59, 98, 161,
    # nAb
    0.81, 0.89, 0.57, 7, 0.76, 11,
    # Anti-S-IgG (U/ml)
    0.65, 0.70, 0.47, 2.60, 0.91, 43
  ),
  Significance = c(
    # IFN-γ (pg/ml)
    "", "", "***", "**", "***", "*",
    
    # Spike-MBC (%)
    "", "", "**", "*", "", "",
    # nAb
    "*", "*", "**", "", "*", "",
    # Anti-S-IgG (U/ml)
    "*", "*", "***", "", "*", ""
  )
)

# Set factor levels (unchanged)
data$Biomarker <- factor(data$Biomarker,
                         levels = c("T cell response\n (IFNg in pg/ml)","Spike-MBC (%)","Neutralising\u2003 \n antibody titres (IC50)" ,"Anti-S-IgG (U/ml)" ))
data$Condition <- factor(data$Condition,
                         levels = c("vaccine-only children", "including hybrid immune children" ))
# Assign alpha based on significance (unchanged)
data$alpha <- ifelse(data$Significance == "", 0.3, 1)

# x positions for dodging (unchanged)
dodge_width <- 0.15
data <- data %>%
  mutate(x_pos = as.numeric(Biomarker) +
           ifelse(Condition == "including hybrid immune children", -dodge_width, dodge_width))

# Plot
HR_plot <- ggplot(data, aes(x = x_pos, y = Hazard_Ratio, color = Condition, shape = Condition)) + # <--- KEY CHANGE 1: Add shape aesthetic
  
  geom_errorbar(data = subset(data, CI_upper <= 2),
                aes(ymin = CI_lower, ymax = CI_upper),
                width = 0.2) +
  
  geom_errorbar(
    data = subset(data, CI_upper > 2),
    aes(ymin = CI_lower, ymax = Hazard_Ratio), 
    width = 0.2
  ) +
  
  geom_segment(data = subset(data, CI_upper > 2),
               aes(x = x_pos, xend = x_pos, y = Hazard_Ratio, yend = 2),
               arrow = arrow(length = unit(0.15, "cm"), ends = "last", type = "closed"),
               lineend = "round", linewidth = 0.5) +
  
  geom_segment(data = subset(data, Hazard_Ratio > 2),
               aes(x = x_pos, xend = x_pos, y = CI_lower, yend = 2),
               arrow = arrow(length = unit(0.15, "cm"), ends = "last", type = "closed"),
               lineend = "round", linewidth = 0.5) +
  
  geom_point(size = 4) +
  geom_text(aes(label = Significance, y = 1.2),
            vjust = 0.6, size = 5, color = "black") +
  
  geom_hline(yintercept = 1, linetype = "dotted", color = "black") +
  
  scale_y_continuous(limits = c(0, 2)) +
  scale_alpha_identity() +
  coord_flip() +
  facet_wrap(~Study_Period) +
  scale_x_continuous(breaks = 1:4, labels = levels(data$Biomarker)) +
  scale_color_manual(values = c(
    "vaccine-only children" = "#3A75C4",    # bright sky/royal blue
    "including hybrid immune children" = "#C43E8B"    # vivid magenta-pink
  )) +
  scale_shape_manual(values = c(
    "vaccine-only children" = 19,                 # Solid Circle
    "including hybrid immune children" = 15       # Solid Square
  )) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(colour = "black", size = 12),
    axis.text.y = element_text(colour = "black", size = 14, face = "bold"),
    axis.ticks = element_line(colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    legend.position = "right",
    legend.title = element_blank(),
    strip.text = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 12, face = "bold"),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_blank(),
    axis.line = element_line(linewidth = 0.6, color = "black")
  ) +
  labs(y = "Hazard Ratio", x = "Biomarker")

HR_plot

```

#################################
########## Figure 3 B ###########
#################################
```{r}
coeff_data <- data.frame(
    Biomarker = rep(c("T cell response", "Spike-MBC", "Neutralising\n antibody titres", "Anti-S-IgG"), each = 3),
  Study_Period = rep(c("30D-3M", "3M-6M", "6M-12M"), times = 4),
  Coeff_Statistic = c(
    # IFNg
    0.04412, -0.8065, -0.4732,
    # Spike-MBC
    0.3407, -0.6073, 0.3851,
    # nAb
    -0.6654, 0.1244, 0.4222,
    # Anti-S-IgG
    -0.6300, -0.2505, 0.9897
  ),
  Significance = c(
    # IFNg
    "", "**", "*",
    # Spike-MBC
    "", "*", "",
    # nAb
    "*", "", "",
    # Anti-S-IgG
    "*", "", ""
  )
)

coeff_data$Study_Period <- factor(coeff_data$Study_Period,
                                  levels = c("30D-3M", "3M-6M", "6M-12M"))
coeff_data$Biomarker <- factor(coeff_data$Biomarker, 
                               levels = c("T cell response", "Spike-MBC", "Neutralising\n antibody titres", "Anti-S-IgG"))
coeff_data$alpha <- ifelse(coeff_data$Significance == "", 0.3, 0.8)
coeff_data$group <- ifelse(coeff_data$Significance == "", "insignificant", "significant")

# Plot the bar chart
coeff_plot1 <- ggplot(coeff_data, aes(x = Biomarker, y = Coeff_Statistic , fill = group, color = group)) +
  geom_bar(stat = "identity", position = position_dodge(width = 1.5)) +
  geom_text(aes(label = Significance), hjust = 1.05, size = 6, color = "black") + 
  labs(
    y = "Coefficient"
  ) +
  coord_flip() +
  facet_wrap(~Study_Period) +
  scale_alpha_identity() +
  scale_fill_manual(values = c("significant" = "#3A75C4", "insignificant" = "#D5E3F3")) +  # Dark blue for sig, light blue for insig
  scale_color_manual(values = c("significant" = "#3A75C4", "insignificant" = "#D5E3F3")) + # Same for border
  scale_y_continuous(expand = expansion(mult = 0.3)) + 
  theme_minimal() +
  theme(
    axis.text = element_text(colour = "black", size = 14),
    axis.ticks = element_line(colour = "black"),
    axis.line = element_line(colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank(),
    strip.text = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 12),
    axis.title.x = element_text(size = 14),
    axis.title.y = element_blank())

# Print the plot
print(coeff_plot1)
```

#################################
########## Figure 3 C ###########
#################################

```{r}
coeff_data <- data.frame(
  Biomarker = rep(c("T cell response", "Spike-MBC", "Neutralising\n antibody titres", "Anti-S-IgG"), each = 3),
  Study_Period = rep(c("30D-3M", "3M-6M", "6M-12M"), times = 4),
  Coeff_Statistic = c(
    # IFNg
    0.01889, -1.0213, -0.7555,
    # Spike-MBC
    0.3339, -0.7622 , 0.4181,
    # nAb
    -0.6785, -0.6591 , -0.7308,
    # Anti-S-IgG
    -0.6432, -0.8082 , -0.5322

  ),
  Significance = c(
    # IFNg
    "","***","***",
    # Spike-MBC
    "","**","",
    # nAb
    "*","**","*",
    # Anti-S-IgG
    "*","***","*"

  )
)

coeff_data$Study_Period <- factor(coeff_data$Study_Period, levels = c("30D-3M", "3M-6M", "6M-12M"))
coeff_data$Biomarker <- factor(coeff_data$Biomarker, 
                               levels = c("T cell response", "Spike-MBC", "Neutralising\n antibody titres", "Anti-S-IgG"))
coeff_data$alpha <- ifelse(coeff_data$Significance == "", 0.3, 0.8)
coeff_data$group <- ifelse(coeff_data$Significance == "", "insignificant", "significant")

# Plot the bar chart
coeff_plot2 <- ggplot(coeff_data, aes(x = Biomarker, y = Coeff_Statistic , fill = group, color = group)) +
  geom_bar(stat = "identity", position = position_dodge(width = 1.5)) +
  geom_text(aes(label = Significance), hjust = 1.05, size = 6, color = "black") + 
  labs(
    y = "Coefficient"
  ) +
  coord_flip() +
  facet_wrap(~Study_Period) +
  scale_alpha_identity() +
   scale_fill_manual(values = c("significant" = "#C43E8B", "insignificant" = "#F3CDE1")) +  
  scale_color_manual(values = c("significant" = "#C43E8B", "insignificant" = "#F3CDE1")) + 
  scale_y_continuous(expand = expansion(mult = 0.3)) + 
  theme_minimal() +
  theme(
    axis.text = element_text(colour = "black", size = 14),
    axis.ticks = element_line(colour = "black"),
    axis.line = element_line(colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank(),
    strip.text = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 12),
    axis.title.x = element_text(size = 14),
    axis.title.y = element_blank())#,
  #  plot.margin = margin(t = 1, r = 1, b = 1, l = 1, unit = "cm")
  #)

# Print the plot
print(coeff_plot2)

```

#################################
########## Figure 4 A ###########
#################################


```{r}

coeff_data <- data.frame(
  Biomarker = rep(c("Neutralising\n antibody titres",  "Spike-MBC", "T cell response"), each = 3),
  Study_Period = rep(c("30D-3M", "3M-6M", "6M-12M"), times = 3),
  Coeff_Statistic = c(-0.6591, -0.2191 , 0.3113,
                      0.3528, -0.4777 , 0.3135 ,
                      0.1037, -0.8428, -0.3475),
  Significance = c("*","","",
                  "","","",
                  "","***","***"
                 
                  )
)

coeff_data$Study_Period <- factor(coeff_data$Study_Period, levels = c("30D-3M", "3M-6M", "6M-12M"))
coeff_data$Biomarker <- factor(coeff_data$Biomarker, levels = c("T cell response","Spike-MBC","Neutralising\n antibody titres" ))
coeff_data$alpha <- ifelse(coeff_data$Significance == "", 0.3, 0.8)
coeff_data$group <- ifelse(coeff_data$Significance == "", "insignificant", "significant")


# Plot the bar chart
coeff_plot3 <- ggplot(coeff_data, aes(x = Biomarker, y = Coeff_Statistic , fill = group, color = group)) +
  geom_bar(stat = "identity", position = position_dodge(width = 1.5)) +
  geom_text(aes(label = Significance), hjust = 1, size = 6, color = "black") + 
  labs(
    y = "Coefficient"
  ) +  geom_hline(yintercept = 0, linetype = "dotted", color = "black", linewidth = 1) +
  coord_flip() +
  facet_wrap(~Study_Period) +
  scale_alpha_identity() +
  scale_fill_manual(values = c("significant" = "#3A75C4", "insignificant" = "#D5E3F3")) +  # Dark blue for sig, light blue for insig
  scale_color_manual(values = c("significant" = "#3A75C4", "insignificant" = "#D5E3F3")) + # Same for border
  scale_y_continuous(expand = expansion(mult = 0.3)) + 
  theme_minimal() +
  theme(
    axis.text = element_text(colour = "black", size = 14),
    axis.ticks = element_line(colour = "black"),
    axis.line = element_line(colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank(),
    strip.text = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 12),
    axis.title.x = element_text(size = 14),
    axis.title.y = element_blank(),
    plot.margin = margin(t = 1, r = 1, b = 1, l = 1, unit = "cm")
  )

# Print the plot
print(coeff_plot3)

```


```{r}
coeff_data <- data.frame(
  Biomarker = rep(c("Neutralising\n antibody titres",  "Spike-MBC", "T cell response"), each = 3),
  Study_Period = rep(c("30D-3M", "3M-6M", "6M-12M"), times = 3),
  Coeff_Statistic = c(-0.67459, -0.4313 , -0.3644,
                      0.35136, -0.4681 , 0.2954 ,
                      0.09338, -1.0503, -0.6555),
  Significance = c("*","","",
                  "","","",
                  "","***","***"
                 
                  )
)

coeff_data$Study_Period <- factor(coeff_data$Study_Period, levels = c("30D-3M", "3M-6M", "6M-12M"))
coeff_data$Biomarker <- factor(coeff_data$Biomarker, levels = c("T cell response","Spike-MBC","Neutralising\n antibody titres" ))
coeff_data$alpha <- ifelse(coeff_data$Significance == "", 0.3, 0.8)
coeff_data$group <- ifelse(coeff_data$Significance == "", "insignificant", "significant")

# Plot the bar chart
coeff_plot4 <- ggplot(coeff_data, aes(x = Biomarker, y = Coeff_Statistic , fill = group, color = group)) +
  geom_bar(stat = "identity", position = position_dodge(width = 1.5)) +
  geom_text(aes(label = Significance), hjust = 1, size = 6, color = "black") + 
  labs(
    y = "Coefficient"
  ) +
  geom_hline(yintercept = 0, linetype = "dotted", color = "black", linewidth = 1) +
  coord_flip() +
  facet_wrap(~Study_Period) +
  scale_alpha_identity() +
  scale_fill_manual(values = c("significant" = "#C43E8B", "insignificant" = "#F3CDE1")) +  
  scale_color_manual(values = c("significant" = "#C43E8B", "insignificant" = "#F3CDE1")) + 
  scale_y_continuous(expand = expansion(mult = 0.3)) + 
  theme_minimal() +
  theme(
    axis.text = element_text(colour = "black", size = 14),
    axis.ticks = element_line(colour = "black"),
    axis.line = element_line(colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    legend.position = "bottom",
    legend.title = element_blank(),
    strip.text = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 12),
    axis.title.x = element_text(size = 14),
    axis.title.y = element_blank(),
    plot.margin = margin(t = 1, r = 1, b = 1, l = 1, unit = "cm")
  )

# Print the plot
print(coeff_plot4)
```



##############################################################
#################### Figure S10 ##############################
##############################################################

```{r}

C_index_df <- data.frame(
  Group = c(rep("Hybrid-Immune", 3), rep("Vaccine-Only", 3)),
  Period = c("30D-3M", "3M-6M", "6M-12M", "30D-3M", "3M-6M", "6M-12M"),
  Full_Model = c(0.728, 0.824, 0.789, 0.725, 0.726, 0.662),
  Leave_nAbs = c(0.609, 0.815, 0.779, 0.614, 0.717, 0.642),
  Leave_MBC  = c(0.698, 0.813, 0.768, 0.696, 0.717, 0.605),
  Leave_IFNg = c(0.721, 0.720, 0.722, 0.713, 0.653, 0.629)
)


plot_data <- C_index_df %>%
  pivot_longer(cols = c(Leave_nAbs, Leave_MBC, Leave_IFNg),
               names_to = "Variable_Removed",
               values_to = "C_Index") %>%
  mutate(

    Variable_Removed = case_when(
      Variable_Removed == "Leave_nAbs" ~ "nAbs",
      Variable_Removed == "Leave_MBC" ~ "S+ MBCs",
      Variable_Removed == "Leave_IFNg" ~ "T cell response",
      TRUE ~ Variable_Removed
    ),

    Variable_Removed = factor(Variable_Removed, levels = c("nAbs", "S+ MBCs", "T cell response")),
    Period = factor(Period, levels = c("30D-3M", "3M-6M", "6M-12M"))
  )


p_hybrid <- ggplot(data = subset(plot_data, Group == "Hybrid-Immune"), 
                   aes(x = Variable_Removed, y = C_Index)) +
  

  geom_bar(stat = "identity", aes(fill = Variable_Removed), 
           width = 0.7, alpha = 0.8) +
  

  geom_hline(aes(yintercept = Full_Model), linetype = "dashed", color = "black", size = 0.8) +
  

  facet_wrap(~ Period) +
  scale_y_continuous(limits = c(0.5, 0.9), oob = scales::rescale_none) + # Zoom in to relevant range
  scale_fill_manual(values = c("#C43E8B", "#C43E8B", "#C43E8B")) + # Your "Red/Pink" hybrid colors
  labs(
    title = "Variable Importance by C-Index Drop (Hybrid-Immune)",
   # subtitle = "Dashed Line = Full Model Performance. Gap = Contribution of Variable.",
    y = "C-Index (Concordance)",
    x = "Variable Removed from Model"
  ) +
  theme_classic() +
  theme(
    strip.background = element_rect(fill = "grey95", color = NA),
    strip.text = element_text(face = "bold", size = 12),
    axis.text.x = element_text(face = "bold",angle = 45, hjust = 1),
    legend.position = "none"
  )

p_vaccine <- ggplot(data = subset(plot_data, Group == "Vaccine-Only"), 
                    aes(x = Variable_Removed, y = C_Index)) +
  
  geom_bar(stat = "identity", aes(fill = Variable_Removed), 
           width = 0.7, alpha = 0.8) +
  
  geom_hline(aes(yintercept = Full_Model), linetype = "dashed", color = "black", size = 0.8) +
  
  facet_wrap(~ Period) +
  
  scale_y_continuous(limits = c(0.5, 0.9), oob = scales::rescale_none) +
  scale_fill_manual(values = c("#3A75C4", "#3A75C4", "#3A75C4")) + # Your "Blue" vaccine colors
  labs(
    title = "Variable Importance by C-Index Drop (Vaccine-Only)",
    y = "C-Index (Concordance)",
    x = "Variable Removed from Model"
  ) +
  theme_classic() +
  theme(
    strip.background = element_rect(fill = "grey95", color = NA),
    strip.text = element_text(face = "bold", size = 12),
    axis.text.x = element_text(face = "bold",angle = 45, hjust = 1),
    legend.position = "none"
  )

print(p_hybrid)
print(p_vaccine)
```


################## END ##################
